name: Deploy Dev Branch to GitHub Pages

on:
  push:
    branches: [ dev ]
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Build project
        run: npm run build
        env:
          NEXT_OUTPUT: export
          GITHUB_ACTIONS: true
          
      - name: Add dev build identifier
        run: |
          # 在页面中添加开发版本标识
          echo "<!-- 🚀 DEV BUILD - $(date) -->" >> ./out/index.html
          
          # 添加开发版本样式和标识
          cat >> ./out/index.html << 'EOF'
          <style>
            .dev-banner {
              position: fixed;
              top: 0;
              left: 0;
              right: 0;
              background: linear-gradient(45deg, #ff6b6b, #ee5a24);
              color: white;
              text-align: center;
              padding: 8px;
              font-size: 14px;
              font-weight: bold;
              z-index: 9999;
              box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            }
            .dev-banner::before {
              content: '🚀 ';
            }
            body {
              padding-top: 40px !important;
            }
          </style>
          <div class="dev-banner">
            开发版本 (DEV BUILD) - 最后更新: $(date)
          </div>
          <script>
            console.log('🚀 DEV BUILD - $(date)');
            console.log('📍 Branch: dev');
            console.log('🔗 Commit: ${{ github.sha }}');
          </script>
          EOF
          
      - name: Deploy to gh-pages-dev branch
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./out
          publish_branch: gh-pages-dev
          force_orphan: true
          commit_message: '🚀 Deploy dev build: ${{ github.sha }}'
          
      - name: Create deployment summary
        run: |
          echo "## 🚀 Dev Build Deployed Successfully!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### 📊 Build Information" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: \`dev\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Build Time**: \`$(date)\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Deploy Branch**: \`gh-pages-dev\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### 🔗 Access Your Dev Build" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "To access your dev build, you need to set up GitHub Pages for the \`gh-pages-dev\` branch:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. Go to **Settings** > **Pages** in your repository" >> $GITHUB_STEP_SUMMARY
          echo "2. Under **Source**, select **Deploy from a branch**" >> $GITHUB_STEP_SUMMARY
          echo "3. Choose **\`gh-pages-dev\`** branch and **\`/ (root)\`** folder" >> $GITHUB_STEP_SUMMARY
          echo "4. Click **Save**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Your dev build will be available at:" >> $GITHUB_STEP_SUMMARY
          echo "\`https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### 🎯 Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "- The dev build includes a visual banner to distinguish it from production" >> $GITHUB_STEP_SUMMARY
          echo "- Each build is timestamped for easy identification" >> $GITHUB_STEP_SUMMARY
          echo "- Check browser console for detailed build information" >> $GITHUB_STEP_SUMMARY

      - name: Output quick access info
        run: |
          echo "✅ Dev build deployed to gh-pages-dev branch"
          echo "🔧 To access: Set up GitHub Pages with gh-pages-dev branch"
          echo "📝 Repository: ${{ github.repository }}"
          echo "🔗 Build commit: ${{ github.sha }}"
